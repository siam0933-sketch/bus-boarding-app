<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ë²„ìŠ¤ íƒ‘ìŠ¹ ê´€ë¦¬</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #f0f2f5;
      overflow-x: hidden;
    }

    .container {
      width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: white;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 16px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      flex-shrink: 0;
    }

    .tabs {
      display: flex;
      background: white;
      overflow-x: auto;
      border-bottom: 2px solid #e0e0e0;
      flex-shrink: 0;
      -webkit-overflow-scrolling: touch;
    }

    .tabs::-webkit-scrollbar {
      display: none;
    }

    .tab {
      flex: 1;
      min-width: 50px;
      padding: 12px 8px;
      text-align: center;
      cursor: pointer;
      border: none;
      background: white;
      font-size: 15px;
      font-weight: 500;
      color: #666;
      transition: all 0.2s;
    }

    .tab.active {
      color: #667eea;
      font-weight: bold;
      border-bottom: 3px solid #667eea;
    }

    .controls {
      padding: 12px;
      background: white;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    .route-select {
      flex: 1;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 15px;
      background: white;
    }

    .edit-btn {
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      font-weight: bold;
      transition: all 0.2s;
    }

    .edit-btn.active {
      background: #FF6B6B;
    }

    .memo-section {
      padding: 12px;
      border-bottom: 1px solid #e0e0e0;
      background: #fffacd;
      flex-shrink: 0;
    }

    .memo-input {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      resize: vertical;
      min-height: 50px;
      font-family: inherit;
    }

    .students-container {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      -webkit-overflow-scrolling: touch;
    }

    .students-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding-bottom: 80px;
    }

    .student-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 2px solid transparent;
      transition: all 0.2s;
      position: relative;
      user-select: none;
      cursor: pointer;
    }

    .student-card.boarded {
      background: #e3f2fd;
      border-color: #2196F3;
    }

    .student-card.status-ê²°ì„ {
      background: #ffebee;
    }

    .student-card.status-ì‹œê°„ë³€ê²½ {
      background: #fff9c4;
    }

    .student-card.status-ì§ì ‘ë“±ì› {
      background: #e8f5e9;
    }

    .student-card.pressing {
      transform: scale(0.98);
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }

    .card-content {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .time {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
      min-width: 70px;
    }

    .station {
      flex: 1;
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }

    .name {
      font-size: 18px;
      font-weight: bold;
      color: #000;
      min-width: 60px;
      text-align: right;
    }

    .status-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #FF6B6B;
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
    }

    .route-badge {
      position: absolute;
      top: 8px;
      left: 8px;
      background: #667eea;
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
    }

    .delete-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #FF6B6B;
      color: white;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      display: none;
      z-index: 10;
    }

    .edit-mode .delete-btn {
      display: block;
    }

    .add-student-form {
      background: #f8f9fa;
      padding: 16px;
      margin-bottom: 16px;
      border-radius: 12px;
      border: 2px dashed #ccc;
      display: none;
    }

    .edit-mode .add-student-form {
      display: block;
    }

    .form-row {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .form-input {
      flex: 1;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 15px;
    }

    .add-btn {
      width: 100%;
      padding: 14px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
    }

    .bottom-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 12px;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
      display: none;
    }

    .bottom-bar.show {
      display: block;
    }

    .reset-btn {
      width: 100%;
      padding: 16px;
      background: #FF6B6B;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(255,107,107,0.3);
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    /* ìƒíƒœ íŒì—… */
    .status-popup {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .status-popup.show {
      display: flex;
      animation: fadeIn 0.2s;
    }

    .popup-content {
      background: white;
      border-radius: 16px;
      padding: 24px;
      width: 100%;
      max-width: 400px;
      animation: slideUp 0.3s;
    }

    .popup-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 20px;
      text-align: center;
    }

    .status-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .status-option {
      padding: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .status-option:active {
      transform: scale(0.95);
    }

    .status-option.ê²°ì„ {
      background: #ffebee;
      border-color: #FF6B6B;
    }

    .status-option.ì‹œê°„ë³€ê²½ {
      background: #fff9c4;
      border-color: #FFC107;
    }

    .status-option.ì§ì ‘ë“±ì› {
      background: #e8f5e9;
      border-color: #4CAF50;
    }

    .status-option.ì·¨ì†Œ {
      background: #f5f5f5;
      border-color: #999;
    }

    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 12px 24px;
      border-radius: 24px;
      display: none;
      z-index: 999;
      font-size: 14px;
      font-weight: 500;
    }

    .toast.show {
      display: block;
      animation: fadeIn 0.3s, fadeOut 0.3s 2.7s;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">ğŸšŒ ë²„ìŠ¤ íƒ‘ìŠ¹ ê´€ë¦¬</div>

    <div class="tabs">
      <button class="tab active" onclick="changeDay('ì›”')">ì›”</button>
      <button class="tab" onclick="changeDay('í™”')">í™”</button>
      <button class="tab" onclick="changeDay('ìˆ˜')">ìˆ˜</button>
      <button class="tab" onclick="changeDay('ëª©')">ëª©</button>
      <button class="tab" onclick="changeDay('ê¸ˆ')">ê¸ˆ</button>
      <button class="tab" onclick="changeDay('í† ')">í† </button>
      <button class="tab" onclick="changeDay('ì¼')">ì¼</button>
    </div>

    <div class="controls">
      <select class="route-select" id="routeSelect" onchange="filterByRoute()">
        <option value="">ì „ì²´ ë…¸ì„ </option>
      </select>
      <button class="edit-btn" id="editBtn" onclick="toggleEditMode()">í¸ì§‘</button>
    </div>

    <div class="memo-section">
      <textarea class="memo-input" id="memoInput" placeholder="ğŸ“ ë©”ëª¨ ì…ë ¥..." oninput="saveMemoDebounced()"></textarea>
    </div>

    <div class="students-container">
      <div class="students-list" id="studentsList">
        <div class="loading">ë¡œë”© ì¤‘...</div>
      </div>
    </div>
  </div>

  <div class="bottom-bar" id="bottomBar">
    <button class="reset-btn" onclick="resetAllBoarding()">ìš´í–‰ ì¢…ë£Œ (ì „ì²´ ì´ˆê¸°í™”)</button>
  </div>

  <!-- ìƒíƒœ íŒì—… -->
  <div class="status-popup" id="statusPopup">
    <div class="popup-content">
      <div class="popup-title" id="popupTitle">ìƒíƒœ ì„ íƒ</div>
      <div class="status-options">
        <div class="status-option ê²°ì„" onclick="setStatus('ê²°ì„')">ê²°ì„</div>
        <div class="status-option ì‹œê°„ë³€ê²½" onclick="setStatus('ì‹œê°„ë³€ê²½')">ì‹œê°„ë³€ê²½</div>
        <div class="status-option ì§ì ‘ë“±ì›" onclick="setStatus('ì§ì ‘ë“±ì›')">ì§ì ‘ë“±ì›</div>
        <div class="status-option ì·¨ì†Œ" onclick="setStatus(null)">ìƒíƒœ ì´ˆê¸°í™”</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    let allStudents = [];
    let currentDay = 'ì›”';
    let currentRoute = '';
    let isEditMode = false;
    let boardedStudents = new Set(); // íƒ‘ìŠ¹í•œ í•™ìƒ ID ì €ì¥
    let memoSaveTimeout = null;
    let longPressTimer = null;
    let currentLongPressStudent = null;

    // ì´ˆê¸° ë¡œë“œ
    window.onload = function() {
      loadAllData();
      loadBoardingState();
    };

    // íƒ‘ìŠ¹ ìƒíƒœ ë¡œì»¬ ì €ì¥ì†Œ ë¡œë“œ
    function loadBoardingState() {
      const saved = localStorage.getItem('boardedStudents_' + currentDay);
      if (saved) {
        boardedStudents = new Set(JSON.parse(saved));
      }
    }

    // íƒ‘ìŠ¹ ìƒíƒœ ë¡œì»¬ ì €ì¥ì†Œ ì €ì¥
    function saveBoardingState() {
      localStorage.setItem('boardedStudents_' + currentDay, JSON.stringify([...boardedStudents]));
    }

    // ëª¨ë“  ë°ì´í„° ë¡œë“œ
    function loadAllData() {
      google.script.run
        .withSuccessHandler(function(students) {
          allStudents = students;
          updateRouteFilter();
          loadMemo();
          renderStudents();
        })
        .withFailureHandler(function(error) {
          showToast('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error);
        })
        .getAllStudents();
    }

    // ìš”ì¼ ë³€ê²½
    function changeDay(day) {
      currentDay = day;
      loadBoardingState();

      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.textContent.includes(day)) {
          tab.classList.add('active');
        }
      });

      updateRouteFilter();
      loadMemo();
      renderStudents();
    }

    // ë…¸ì„  í•„í„° ì—…ë°ì´íŠ¸
    function updateRouteFilter() {
      const dayStudents = allStudents.filter(s => s.day === currentDay);
      const routes = [...new Set(dayStudents.map(s => s.route))].filter(r => r);

      const select = document.getElementById('routeSelect');
      select.innerHTML = '<option value="">ì „ì²´ ë…¸ì„ </option>';
      routes.forEach(route => {
        const option = document.createElement('option');
        option.value = route;
        option.textContent = route;
        if (route === currentRoute) option.selected = true;
        select.appendChild(option);
      });
    }

    // ë…¸ì„ ë³„ í•„í„°
    function filterByRoute() {
      currentRoute = document.getElementById('routeSelect').value;
      renderStudents();
    }

    // ë©”ëª¨ ë¡œë“œ
    function loadMemo() {
      google.script.run
        .withSuccessHandler(function(memo) {
          document.getElementById('memoInput').value = memo;
        })
        .getMemo(currentDay);
    }

    // ë©”ëª¨ ì €ì¥ (ë””ë°”ìš´ìŠ¤)
    function saveMemoDebounced() {
      if (memoSaveTimeout) clearTimeout(memoSaveTimeout);
      memoSaveTimeout = setTimeout(function() {
        const memo = document.getElementById('memoInput').value;
        google.script.run
          .withSuccessHandler(function() {
            // ìë™ ì €ì¥
          })
          .saveMemo(currentDay, memo);
      }, 1000);
    }

    // í•™ìƒ ëª©ë¡ ë Œë”ë§
    function renderStudents() {
      let students = allStudents.filter(s => s.day === currentDay);

      if (currentRoute) {
        students = students.filter(s => s.route === currentRoute);
      }

      // ì‹œê°„ìˆœ ì •ë ¬
      students.sort((a, b) => {
        if (a.time < b.time) return -1;
        if (a.time > b.time) return 1;
        return 0;
      });

      const container = document.getElementById('studentsList');

      if (students.length === 0) {
        container.innerHTML = '<div class="loading">í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        document.getElementById('bottomBar').classList.remove('show');
        return;
      }

      let html = '';

      // í¸ì§‘ ëª¨ë“œì¼ ë•Œ ì¶”ê°€ í¼
      if (isEditMode) {
        html += `
          <div class="add-student-form">
            <div class="form-row">
              <input type="text" class="form-input" id="newName" placeholder="ì´ë¦„">
              <input type="text" class="form-input" id="newRoute" placeholder="ë…¸ì„ ">
            </div>
            <div class="form-row">
              <input type="text" class="form-input" id="newStation" placeholder="ì •ë¥˜ì¥">
              <input type="time" class="form-input" id="newTime">
            </div>
            <button class="add-btn" onclick="addNewStudent()">+ í•™ìƒ ì¶”ê°€</button>
          </div>
        `;
      }

      students.forEach(student => {
        const isBoarded = boardedStudents.has(student.id);
        const boardedClass = isBoarded ? 'boarded' : '';
        const statusClass = student.status ? 'status-' + student.status : '';

        html += `
          <div class="student-card ${boardedClass} ${statusClass}"
               data-id="${student.id}"
               data-name="${student.name}"
               ontouchstart="handleTouchStart(event, '${student.id}', '${student.name}')"
               ontouchend="handleTouchEnd(event, '${student.id}')"
               ontouchcancel="handleTouchCancel()"
               onclick="toggleBoarding('${student.id}')">
            ${isEditMode ? `<button class="delete-btn" onclick="event.stopPropagation(); deleteStudent('${student.name}')">Ã—</button>` : ''}
            ${student.route ? `<div class="route-badge">${student.route}</div>` : ''}
            ${student.status ? `<div class="status-badge">${student.status}</div>` : ''}
            <div class="card-content">
              <div class="time">${student.time}</div>
              <div class="station">${student.station}</div>
              <div class="name">${student.name}</div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;

      // íƒ‘ìŠ¹í•œ í•™ìƒì´ ìˆìœ¼ë©´ í•˜ë‹¨ë°” í‘œì‹œ
      if (boardedStudents.size > 0) {
        document.getElementById('bottomBar').classList.add('show');
      } else {
        document.getElementById('bottomBar').classList.remove('show');
      }
    }

    // í„°ì¹˜ ì‹œì‘ (ë¡±í”„ë ˆìŠ¤ ê°ì§€)
    function handleTouchStart(event, studentId, studentName) {
      if (isEditMode) return;

      const card = event.currentTarget;
      card.classList.add('pressing');

      currentLongPressStudent = { id: studentId, name: studentName };

      longPressTimer = setTimeout(function() {
        // 0.5ì´ˆ í›„ íŒì—… í‘œì‹œ
        showStatusPopup(studentName);
        navigator.vibrate && navigator.vibrate(50); // ì§„ë™ í”¼ë“œë°±
      }, 500);
    }

    // í„°ì¹˜ ì¢…ë£Œ
    function handleTouchEnd(event, studentId) {
      const card = event.currentTarget;
      card.classList.remove('pressing');

      if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
      }
    }

    // í„°ì¹˜ ì·¨ì†Œ
    function handleTouchCancel() {
      if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
      }
      document.querySelectorAll('.student-card').forEach(card => {
        card.classList.remove('pressing');
      });
    }

    // íƒ‘ìŠ¹ í† ê¸€
    function toggleBoarding(studentId) {
      if (isEditMode) return;
      if (longPressTimer) return; // ë¡±í”„ë ˆìŠ¤ ì¤‘ì´ë©´ ë¬´ì‹œ

      if (boardedStudents.has(studentId)) {
        boardedStudents.delete(studentId);
      } else {
        boardedStudents.add(studentId);
      }

      saveBoardingState();
      renderStudents();
    }

    // ìƒíƒœ íŒì—… í‘œì‹œ
    function showStatusPopup(studentName) {
      document.getElementById('popupTitle').textContent = studentName + ' ìƒíƒœ ì„ íƒ';
      document.getElementById('statusPopup').classList.add('show');
    }

    // ìƒíƒœ ì„¤ì •
    function setStatus(status) {
      const popup = document.getElementById('statusPopup');
      popup.classList.remove('show');

      if (!currentLongPressStudent) return;

      const studentName = currentLongPressStudent.name;

      google.script.run
        .withSuccessHandler(function() {
          showToast(status ? status + ' ì„¤ì •ë¨' : 'ìƒíƒœ ì´ˆê¸°í™”ë¨');
          loadAllData();
        })
        .withFailureHandler(function(error) {
          showToast('ì˜¤ë¥˜: ' + error);
        })
        .updateStatus(studentName, status, currentDay);

      currentLongPressStudent = null;
    }

    // í¸ì§‘ ëª¨ë“œ í† ê¸€
    function toggleEditMode() {
      isEditMode = !isEditMode;
      const btn = document.getElementById('editBtn');
      const list = document.getElementById('studentsList');

      if (isEditMode) {
        btn.textContent = 'ì™„ë£Œ';
        btn.classList.add('active');
        list.classList.add('edit-mode');
      } else {
        btn.textContent = 'í¸ì§‘';
        btn.classList.remove('active');
        list.classList.remove('edit-mode');
      }

      renderStudents();
    }

    // ì „ì²´ íƒ‘ìŠ¹ ì´ˆê¸°í™”
    function resetAllBoarding() {
      if (!confirm('ëª¨ë“  íƒ‘ìŠ¹ ì²´í¬ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      boardedStudents.clear();
      saveBoardingState();
      renderStudents();
      showToast('íƒ‘ìŠ¹ ì²´í¬ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    // í•™ìƒ ì¶”ê°€
    function addNewStudent() {
      const name = document.getElementById('newName').value.trim();
      const route = document.getElementById('newRoute').value.trim();
      const station = document.getElementById('newStation').value.trim();
      const time = document.getElementById('newTime').value;

      if (!name) {
        showToast('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }

      google.script.run
        .withSuccessHandler(function() {
          showToast('í•™ìƒì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
          document.getElementById('newName').value = '';
          document.getElementById('newRoute').value = '';
          document.getElementById('newStation').value = '';
          document.getElementById('newTime').value = '';
          loadAllData();
        })
        .withFailureHandler(function(error) {
          showToast('ì˜¤ë¥˜: ' + error);
        })
        .addStudent(name, route, station, time, currentDay);
    }

    // í•™ìƒ ì‚­ì œ
    function deleteStudent(name) {
      if (!confirm(name + 'ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      google.script.run
        .withSuccessHandler(function() {
          showToast('í•™ìƒì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadAllData();
        })
        .withFailureHandler(function(error) {
          showToast('ì˜¤ë¥˜: ' + error);
        })
        .removeStudent(name, currentDay);
    }

    // í† ìŠ¤íŠ¸ ë©”ì‹œì§€
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(function() {
        toast.classList.remove('show');
      }, 3000);
    }

    // íŒì—… ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
    document.getElementById('statusPopup').addEventListener('click', function(e) {
      if (e.target === this) {
        this.classList.remove('show');
        currentLongPressStudent = null;
      }
    });
  </script>
</body>
</html>
