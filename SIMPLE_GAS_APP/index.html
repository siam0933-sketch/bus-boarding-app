<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Î≤ÑÏä§ ÌÉëÏäπ Í¥ÄÎ¶¨</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #f0f2f5;
      overflow-x: hidden;
    }

    .container {
      width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: white;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 16px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      flex-shrink: 0;
    }

    .tabs {
      display: flex;
      background: white;
      overflow-x: auto;
      border-bottom: 2px solid #e0e0e0;
      flex-shrink: 0;
      -webkit-overflow-scrolling: touch;
    }

    .tabs::-webkit-scrollbar {
      display: none;
    }

    .tab {
      flex: 1;
      min-width: 50px;
      padding: 12px 8px;
      text-align: center;
      cursor: pointer;
      border: none;
      background: white;
      font-size: 15px;
      font-weight: 500;
      color: #666;
      transition: all 0.2s;
    }

    .tab.active {
      color: #667eea;
      font-weight: bold;
      border-bottom: 3px solid #667eea;
    }

    .controls {
      padding: 12px;
      background: white;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }

    .route-select {
      flex: 1;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 15px;
      background: white;
    }

    .edit-btn {
      padding: 10px 20px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
      font-weight: bold;
      transition: all 0.2s;
    }

    .edit-btn.active {
      background: #FF6B6B;
    }

    .memo-section {
      padding: 12px;
      border-bottom: 1px solid #e0e0e0;
      background: #fffacd;
      flex-shrink: 0;
    }

    .memo-input {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      resize: vertical;
      min-height: 50px;
      font-family: inherit;
    }

    .students-container {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      -webkit-overflow-scrolling: touch;
    }

    .students-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding-bottom: 80px;
    }

    .student-card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 2px solid transparent;
      transition: all 0.2s;
      position: relative;
      user-select: none;
      cursor: pointer;
    }

    .student-card.boarded {
      background: #e3f2fd;
      border-color: #2196F3;
    }

    .student-card.status-Í≤∞ÏÑù {
      background: #ffebee;
    }

    .student-card.status-ÏãúÍ∞ÑÎ≥ÄÍ≤Ω {
      background: #fff9c4;
    }

    .student-card.status-ÏßÅÏ†ëÎì±Ïõê {
      background: #e8f5e9;
    }

    .student-card.pressing {
      transform: scale(0.98);
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }

    .card-content {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .time {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
      min-width: 70px;
    }

    .station {
      flex: 1;
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }

    .name {
      font-size: 18px;
      font-weight: bold;
      color: #000;
      min-width: 60px;
      text-align: right;
    }

    .status-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #FF6B6B;
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
    }

    .route-badge {
      position: absolute;
      top: 8px;
      left: 8px;
      background: #667eea;
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
    }

    .delete-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #FF6B6B;
      color: white;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      display: none;
      z-index: 10;
    }

    .edit-mode .delete-btn {
      display: block;
    }

    .add-student-form {
      background: #f8f9fa;
      padding: 16px;
      margin-bottom: 16px;
      border-radius: 12px;
      border: 2px dashed #ccc;
      display: none;
    }

    .edit-mode .add-student-form {
      display: block;
    }

    .form-row {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .form-input {
      flex: 1;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 15px;
    }

    .add-btn {
      width: 100%;
      padding: 14px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
    }

    .bottom-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 12px;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
      display: none;
    }

    .bottom-bar.show {
      display: block;
    }

    .reset-btn {
      width: 100%;
      padding: 16px;
      background: #FF6B6B;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(255,107,107,0.3);
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    /* ÏÉÅÌÉú ÌåùÏóÖ */
    .status-popup {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .status-popup.show {
      display: flex;
      animation: fadeIn 0.2s;
    }

    .popup-content {
      background: white;
      border-radius: 16px;
      padding: 24px;
      width: 100%;
      max-width: 400px;
      animation: slideUp 0.3s;
    }

    .popup-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 20px;
      text-align: center;
    }

    .status-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .status-option {
      padding: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .status-option:active {
      transform: scale(0.95);
    }

    .status-option.Í≤∞ÏÑù {
      background: #ffebee;
      border-color: #FF6B6B;
    }

    .status-option.ÏãúÍ∞ÑÎ≥ÄÍ≤Ω {
      background: #fff9c4;
      border-color: #FFC107;
    }

    .status-option.ÏßÅÏ†ëÎì±Ïõê {
      background: #e8f5e9;
      border-color: #4CAF50;
    }

    .status-option.Ï∑®ÏÜå {
      background: #f5f5f5;
      border-color: #999;
    }

    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 12px 24px;
      border-radius: 24px;
      display: none;
      z-index: 999;
      font-size: 14px;
      font-weight: 500;
    }

    .toast.show {
      display: block;
      animation: fadeIn 0.3s, fadeOut 0.3s 2.7s;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">üöå Î≤ÑÏä§ ÌÉëÏäπ Í¥ÄÎ¶¨</div>

    <div class="tabs">
      <button class="tab active" onclick="changeDay('Ïõî')">Ïõî</button>
      <button class="tab" onclick="changeDay('Ìôî')">Ìôî</button>
      <button class="tab" onclick="changeDay('Ïàò')">Ïàò</button>
      <button class="tab" onclick="changeDay('Î™©')">Î™©</button>
      <button class="tab" onclick="changeDay('Í∏à')">Í∏à</button>
      <button class="tab" onclick="changeDay('ÌÜ†')">ÌÜ†</button>
      <button class="tab" onclick="changeDay('Ïùº')">Ïùº</button>
    </div>

    <div class="controls">
      <select class="route-select" id="routeSelect" onchange="filterByRoute()">
        <option value="">Ï†ÑÏ≤¥ ÎÖ∏ÏÑ†</option>
      </select>
      <button class="edit-btn" id="editBtn" onclick="toggleEditMode()">Ìé∏Ïßë</button>
    </div>

    <div class="memo-section">
      <textarea class="memo-input" id="memoInput" placeholder="üìù Î©îÎ™® ÏûÖÎ†•..." oninput="saveMemoDebounced()"></textarea>
    </div>

    <div class="students-container">
      <div class="students-list" id="studentsList">
        <div class="loading">Î°úÎî© Ï§ë...</div>
      </div>
    </div>
  </div>

  <div class="bottom-bar" id="bottomBar">
    <button class="reset-btn" onclick="resetAllBoarding()">Ïö¥Ìñâ Ï¢ÖÎ£å (Ï†ÑÏ≤¥ Ï¥àÍ∏∞Ìôî)</button>
  </div>

  <!-- ÏÉÅÌÉú ÌåùÏóÖ -->
  <div class="status-popup" id="statusPopup">
    <div class="popup-content">
      <div class="popup-title" id="popupTitle">ÏÉÅÌÉú ÏÑ†ÌÉù</div>
      <div class="status-options">
        <div class="status-option Í≤∞ÏÑù" onclick="setStatus('Í≤∞ÏÑù')">Í≤∞ÏÑù</div>
        <div class="status-option ÏãúÍ∞ÑÎ≥ÄÍ≤Ω" onclick="setStatus('ÏãúÍ∞ÑÎ≥ÄÍ≤Ω')">ÏãúÍ∞ÑÎ≥ÄÍ≤Ω</div>
        <div class="status-option ÏßÅÏ†ëÎì±Ïõê" onclick="setStatus('ÏßÅÏ†ëÎì±Ïõê')">ÏßÅÏ†ëÎì±Ïõê</div>
        <div class="status-option Ï∑®ÏÜå" onclick="setStatus(null)">ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî</div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    let allStudents = [];
    let currentDay = 'Ïõî';
    let currentRoute = '';
    let isEditMode = false;
    let boardedStudents = new Set(); // ÌÉëÏäπÌïú ÌïôÏÉù ID Ï†ÄÏû•
    let memoSaveTimeout = null;
    let longPressTimer = null;
    let currentLongPressStudent = null;

    // Ï¥àÍ∏∞ Î°úÎìú
    window.onload = function() {
      loadAllData();
      loadBoardingState();
    };

    // ÌÉëÏäπ ÏÉÅÌÉú Î°úÏª¨ Ï†ÄÏû•ÏÜå Î°úÎìú
    function loadBoardingState() {
      const saved = localStorage.getItem('boardedStudents_' + currentDay);
      if (saved) {
        boardedStudents = new Set(JSON.parse(saved));
      }
    }

    // ÌÉëÏäπ ÏÉÅÌÉú Î°úÏª¨ Ï†ÄÏû•ÏÜå Ï†ÄÏû•
    function saveBoardingState() {
      localStorage.setItem('boardedStudents_' + currentDay, JSON.stringify([...boardedStudents]));
    }

    // Î™®Îì† Îç∞Ïù¥ÌÑ∞ Î°úÎìú
    function loadAllData() {
      google.script.run
        .withSuccessHandler(function(students) {
          allStudents = students;
          updateRouteFilter();
          loadMemo();
          renderStudents();
        })
        .withFailureHandler(function(error) {
          showToast('Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®: ' + error);
        })
        .getAllStudents();
    }

    // ÏöîÏùº Î≥ÄÍ≤Ω
    function changeDay(day) {
      currentDay = day;
      loadBoardingState();

      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.textContent.includes(day)) {
          tab.classList.add('active');
        }
      });

      updateRouteFilter();
      loadMemo();
      renderStudents();
    }

    // ÎÖ∏ÏÑ† ÌïÑÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
    function updateRouteFilter() {
      const dayStudents = allStudents.filter(s => s.day === currentDay);
      const routes = [...new Set(dayStudents.map(s => s.route))].filter(r => r);

      const select = document.getElementById('routeSelect');
      select.innerHTML = '<option value="">Ï†ÑÏ≤¥ ÎÖ∏ÏÑ†</option>';
      routes.forEach(route => {
        const option = document.createElement('option');
        option.value = route;
        option.textContent = route;
        if (route === currentRoute) option.selected = true;
        select.appendChild(option);
      });
    }

    // ÎÖ∏ÏÑ†Î≥Ñ ÌïÑÌÑ∞
    function filterByRoute() {
      currentRoute = document.getElementById('routeSelect').value;
      renderStudents();
    }

    // Î©îÎ™® Î°úÎìú
    function loadMemo() {
      google.script.run
        .withSuccessHandler(function(memo) {
          document.getElementById('memoInput').value = memo;
        })
        .getMemo(currentDay);
    }

    // Î©îÎ™® Ï†ÄÏû• (ÎîîÎ∞îÏö¥Ïä§)
    function saveMemoDebounced() {
      if (memoSaveTimeout) clearTimeout(memoSaveTimeout);
      memoSaveTimeout = setTimeout(function() {
        const memo = document.getElementById('memoInput').value;
        google.script.run
          .withSuccessHandler(function() {
            // ÏûêÎèô Ï†ÄÏû•
          })
          .saveMemo(currentDay, memo);
      }, 1000);
    }

    // ÌïôÏÉù Î™©Î°ù Î†åÎçîÎßÅ
    function renderStudents() {
      let students = allStudents.filter(s => s.day === currentDay);

      if (currentRoute) {
        students = students.filter(s => s.route === currentRoute);
      }

      // ÏãúÍ∞ÑÏàú Ï†ïÎ†¨
      students.sort((a, b) => {
        if (a.time < b.time) return -1;
        if (a.time > b.time) return 1;
        return 0;
      });

      const container = document.getElementById('studentsList');

      if (students.length === 0) {
        container.innerHTML = '<div class="loading">ÌïôÏÉùÏù¥ ÏóÜÏäµÎãàÎã§.</div>';
        document.getElementById('bottomBar').classList.remove('show');
        return;
      }

      let html = '';

      // Ìé∏Ïßë Î™®ÎìúÏùº Îïå Ï∂îÍ∞Ä Ìèº
      if (isEditMode) {
        html += `
          <div class="add-student-form">
            <div class="form-row">
              <input type="text" class="form-input" id="newName" placeholder="Ïù¥Î¶Ñ">
              <input type="text" class="form-input" id="newRoute" placeholder="ÎÖ∏ÏÑ†">
            </div>
            <div class="form-row">
              <input type="text" class="form-input" id="newStation" placeholder="Ï†ïÎ•òÏû•">
              <input type="time" class="form-input" id="newTime">
            </div>
            <button class="add-btn" onclick="addNewStudent()">+ ÌïôÏÉù Ï∂îÍ∞Ä</button>
          </div>
        `;
      }

      students.forEach(student => {
        const isBoarded = boardedStudents.has(student.id);
        const boardedClass = isBoarded ? 'boarded' : '';
        const statusClass = student.status ? 'status-' + student.status : '';

        html += `
          <div class="student-card ${boardedClass} ${statusClass}"
               data-id="${student.id}"
               data-name="${student.name}"
               ontouchstart="handleTouchStart(event, '${student.id}', '${student.name}')"
               ontouchend="handleTouchEnd(event, '${student.id}')"
               ontouchcancel="handleTouchCancel()"
               onclick="toggleBoarding('${student.id}')">
            ${isEditMode ? `<button class="delete-btn" onclick="event.stopPropagation(); deleteStudent('${student.name}')">√ó</button>` : ''}
            ${student.route ? `<div class="route-badge">${student.route}</div>` : ''}
            ${student.status ? `<div class="status-badge">${student.status}</div>` : ''}
            <div class="card-content">
              <div class="time">${student.time}</div>
              <div class="station">${student.station}</div>
              <div class="name">${student.name}</div>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;

      // ÌÉëÏäπÌïú ÌïôÏÉùÏù¥ ÏûàÏúºÎ©¥ ÌïòÎã®Î∞î ÌëúÏãú
      if (boardedStudents.size > 0) {
        document.getElementById('bottomBar').classList.add('show');
      } else {
        document.getElementById('bottomBar').classList.remove('show');
      }
    }

    // ÌÑ∞Ïπò ÏãúÏûë (Î°±ÌîÑÎ†àÏä§ Í∞êÏßÄ)
    function handleTouchStart(event, studentId, studentName) {
      if (isEditMode) return;

      const card = event.currentTarget;
      card.classList.add('pressing');

      currentLongPressStudent = { id: studentId, name: studentName };

      longPressTimer = setTimeout(function() {
        // 0.5Ï¥à ÌõÑ ÌåùÏóÖ ÌëúÏãú
        showStatusPopup(studentName);
        navigator.vibrate && navigator.vibrate(50); // ÏßÑÎèô ÌîºÎìúÎ∞±
      }, 500);
    }

    // ÌÑ∞Ïπò Ï¢ÖÎ£å
    function handleTouchEnd(event, studentId) {
      const card = event.currentTarget;
      card.classList.remove('pressing');

      if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
      }
    }

    // ÌÑ∞Ïπò Ï∑®ÏÜå
    function handleTouchCancel() {
      if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
      }
      document.querySelectorAll('.student-card').forEach(card => {
        card.classList.remove('pressing');
      });
    }

    // ÌÉëÏäπ ÌÜ†Í∏Ä
    function toggleBoarding(studentId) {
      if (isEditMode) return;
      if (longPressTimer) return; // Î°±ÌîÑÎ†àÏä§ Ï§ëÏù¥Î©¥ Î¨¥Ïãú

      if (boardedStudents.has(studentId)) {
        boardedStudents.delete(studentId);
      } else {
        boardedStudents.add(studentId);
      }

      saveBoardingState();
      renderStudents();
    }

    // ÏÉÅÌÉú ÌåùÏóÖ ÌëúÏãú
    function showStatusPopup(studentName) {
      document.getElementById('popupTitle').textContent = studentName + ' ÏÉÅÌÉú ÏÑ†ÌÉù';
      document.getElementById('statusPopup').classList.add('show');
    }

    // ÏÉÅÌÉú ÏÑ§Ï†ï
    function setStatus(status) {
      const popup = document.getElementById('statusPopup');
      popup.classList.remove('show');

      if (!currentLongPressStudent) return;

      const studentName = currentLongPressStudent.name;

      google.script.run
        .withSuccessHandler(function() {
          showToast(status ? status + ' ÏÑ§Ï†ïÎê®' : 'ÏÉÅÌÉú Ï¥àÍ∏∞ÌôîÎê®');
          loadAllData();
        })
        .withFailureHandler(function(error) {
          showToast('Ïò§Î•ò: ' + error);
        })
        .updateStatus(studentName, status, currentDay);

      currentLongPressStudent = null;
    }

    // Ìé∏Ïßë Î™®Îìú ÌÜ†Í∏Ä
    function toggleEditMode() {
      isEditMode = !isEditMode;
      const btn = document.getElementById('editBtn');
      const list = document.getElementById('studentsList');

      if (isEditMode) {
        btn.textContent = 'ÏôÑÎ£å';
        btn.classList.add('active');
        list.classList.add('edit-mode');
      } else {
        btn.textContent = 'Ìé∏Ïßë';
        btn.classList.remove('active');
        list.classList.remove('edit-mode');
      }

      renderStudents();
    }

    // Ï†ÑÏ≤¥ ÌÉëÏäπ Ï¥àÍ∏∞Ìôî
    function resetAllBoarding() {
      if (!confirm('Î™®Îì† ÌÉëÏäπ Ï≤¥ÌÅ¨Î•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;

      boardedStudents.clear();
      saveBoardingState();
      renderStudents();
      showToast('ÌÉëÏäπ Ï≤¥ÌÅ¨Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.');
    }

    // ÌïôÏÉù Ï∂îÍ∞Ä
    function addNewStudent() {
      const name = document.getElementById('newName').value.trim();
      const route = document.getElementById('newRoute').value.trim();
      const station = document.getElementById('newStation').value.trim();
      const time = document.getElementById('newTime').value;

      if (!name) {
        showToast('Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
        return;
      }

      google.script.run
        .withSuccessHandler(function() {
          showToast('ÌïôÏÉùÏù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.');
          document.getElementById('newName').value = '';
          document.getElementById('newRoute').value = '';
          document.getElementById('newStation').value = '';
          document.getElementById('newTime').value = '';
          loadAllData();
        })
        .withFailureHandler(function(error) {
          showToast('Ïò§Î•ò: ' + error);
        })
        .addStudent(name, route, station, time, currentDay);
    }

    // ÌïôÏÉù ÏÇ≠Ï†ú
    function deleteStudent(name) {
      if (!confirm(name + 'ÏùÑ(Î•º) ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;

      google.script.run
        .withSuccessHandler(function() {
          showToast('ÌïôÏÉùÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
          loadAllData();
        })
        .withFailureHandler(function(error) {
          showToast('Ïò§Î•ò: ' + error);
        })
        .removeStudent(name, currentDay);
    }

    // ÌÜ†Ïä§Ìä∏ Î©îÏãúÏßÄ
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(function() {
        toast.classList.remove('show');
      }, 3000);
    }

    // ÌåùÏóÖ Ïô∏Î∂Ä ÌÅ¥Î¶≠Ïãú Îã´Í∏∞
    document.getElementById('statusPopup').addEventListener('click', function(e) {
      if (e.target === this) {
        this.classList.remove('show');
        currentLongPressStudent = null;
      }
    });
  </script>
</body>
</html>
