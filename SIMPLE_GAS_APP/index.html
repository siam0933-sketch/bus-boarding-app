<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë²„ìŠ¤ íƒ‘ìŠ¹ ê´€ë¦¬</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #f5f5f5;
      padding: 8px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .header {
      background: #2196F3;
      color: white;
      padding: 16px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
    }

    .tabs {
      display: flex;
      border-bottom: 2px solid #e0e0e0;
      background: white;
      overflow-x: auto;
    }

    .tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      border: none;
      background: white;
      font-size: 14px;
      min-width: 60px;
    }

    .tab.active {
      background: #2196F3;
      color: white;
      font-weight: bold;
    }

    .controls {
      padding: 12px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .route-select {
      flex: 1;
      min-width: 120px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }

    .edit-btn {
      padding: 8px 16px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
    }

    .edit-btn.active {
      background: #FF9800;
    }

    .memo-section {
      padding: 12px;
      border-bottom: 1px solid #e0e0e0;
    }

    .memo-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      resize: vertical;
      min-height: 60px;
    }

    .students-list {
      padding: 8px;
    }

    .student-item {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      padding: 12px;
      margin-bottom: 8px;
      position: relative;
    }

    .student-item.status-ê²°ì„ {
      background: #FFB3BA;
    }

    .student-item.status-ì‹œê°„ë³€ê²½ {
      background: #FFFFBA;
    }

    .student-item.status-ì§ì ‘ë“±ì› {
      background: #BAE1FF;
    }

    .student-name {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 4px;
    }

    .student-info {
      font-size: 13px;
      color: #666;
      margin-bottom: 8px;
    }

    .student-actions {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .status-btn {
      padding: 6px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      font-size: 12px;
    }

    .status-btn.active {
      background: #2196F3;
      color: white;
      border-color: #2196F3;
    }

    .delete-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 16px;
      display: none;
    }

    .edit-mode .delete-btn {
      display: block;
    }

    .add-student-form {
      background: #f9f9f9;
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 4px;
      border: 2px dashed #ccc;
      display: none;
    }

    .edit-mode .add-student-form {
      display: block;
    }

    .form-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .form-input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }

    .add-btn {
      width: 100%;
      padding: 10px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #323232;
      color: white;
      padding: 12px 24px;
      border-radius: 4px;
      display: none;
      z-index: 1000;
    }

    .toast.show {
      display: block;
      animation: fadeIn 0.3s, fadeOut 0.3s 2.7s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateX(-50%) translateY(20px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">ğŸšŒ ë²„ìŠ¤ íƒ‘ìŠ¹ ê´€ë¦¬</div>

    <div class="tabs">
      <button class="tab active" onclick="changeDay('ì›”')">ì›”</button>
      <button class="tab" onclick="changeDay('í™”')">í™”</button>
      <button class="tab" onclick="changeDay('ìˆ˜')">ìˆ˜</button>
      <button class="tab" onclick="changeDay('ëª©')">ëª©</button>
      <button class="tab" onclick="changeDay('ê¸ˆ')">ê¸ˆ</button>
      <button class="tab" onclick="changeDay('í† ')">í† </button>
      <button class="tab" onclick="changeDay('ì¼')">ì¼</button>
    </div>

    <div class="controls">
      <select class="route-select" id="routeSelect" onchange="filterByRoute()">
        <option value="">ì „ì²´ ë…¸ì„ </option>
      </select>
      <button class="edit-btn" id="editBtn" onclick="toggleEditMode()">ì¶”ê°€ì‚­ì œ</button>
    </div>

    <div class="memo-section">
      <textarea class="memo-input" id="memoInput" placeholder="ë©”ëª¨ ì…ë ¥..." oninput="saveMemoDebounced()"></textarea>
    </div>

    <div class="students-list" id="studentsList">
      <div class="loading">ë¡œë”© ì¤‘...</div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    let allStudents = [];
    let currentDay = 'ì›”';
    let currentRoute = '';
    let isEditMode = false;
    let memoSaveTimeout = null;

    // ì´ˆê¸° ë¡œë“œ
    window.onload = function() {
      loadAllData();
    };

    // ëª¨ë“  ë°ì´í„° ë¡œë“œ
    function loadAllData() {
      google.script.run
        .withSuccessHandler(function(students) {
          allStudents = students;
          updateRouteFilter();
          loadMemo();
          renderStudents();
        })
        .withFailureHandler(function(error) {
          showToast('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + error);
        })
        .getAllStudents();
    }

    // ìš”ì¼ ë³€ê²½
    function changeDay(day) {
      currentDay = day;

      // íƒ­ í™œì„±í™”
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.textContent.includes(day)) {
          tab.classList.add('active');
        }
      });

      updateRouteFilter();
      loadMemo();
      renderStudents();
    }

    // ë…¸ì„  í•„í„° ì—…ë°ì´íŠ¸
    function updateRouteFilter() {
      const dayStudents = allStudents.filter(s => s.day === currentDay);
      const routes = [...new Set(dayStudents.map(s => s.route))].filter(r => r);

      const select = document.getElementById('routeSelect');
      select.innerHTML = '<option value="">ì „ì²´ ë…¸ì„ </option>';
      routes.forEach(route => {
        const option = document.createElement('option');
        option.value = route;
        option.textContent = route;
        if (route === currentRoute) option.selected = true;
        select.appendChild(option);
      });
    }

    // ë…¸ì„ ë³„ í•„í„°
    function filterByRoute() {
      currentRoute = document.getElementById('routeSelect').value;
      renderStudents();
    }

    // ë©”ëª¨ ë¡œë“œ
    function loadMemo() {
      google.script.run
        .withSuccessHandler(function(memo) {
          document.getElementById('memoInput').value = memo;
        })
        .getMemo(currentDay);
    }

    // ë©”ëª¨ ì €ì¥ (ë””ë°”ìš´ìŠ¤)
    function saveMemoDebounced() {
      if (memoSaveTimeout) clearTimeout(memoSaveTimeout);
      memoSaveTimeout = setTimeout(function() {
        const memo = document.getElementById('memoInput').value;
        google.script.run
          .withSuccessHandler(function() {
            // ìë™ ì €ì¥ - í† ìŠ¤íŠ¸ í‘œì‹œ ì•ˆ í•¨
          })
          .saveMemo(currentDay, memo);
      }, 1000);
    }

    // í•™ìƒ ëª©ë¡ ë Œë”ë§
    function renderStudents() {
      let students = allStudents.filter(s => s.day === currentDay);

      if (currentRoute) {
        students = students.filter(s => s.route === currentRoute);
      }

      const container = document.getElementById('studentsList');

      if (students.length === 0) {
        container.innerHTML = '<div class="loading">í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      let html = '';

      // í¸ì§‘ ëª¨ë“œì¼ ë•Œ ì¶”ê°€ í¼
      if (isEditMode) {
        html += `
          <div class="add-student-form">
            <div class="form-row">
              <input type="text" class="form-input" id="newName" placeholder="ì´ë¦„">
              <input type="text" class="form-input" id="newRoute" placeholder="ë…¸ì„ ">
            </div>
            <div class="form-row">
              <input type="text" class="form-input" id="newStation" placeholder="ì •ë¥˜ì¥">
              <input type="time" class="form-input" id="newTime">
            </div>
            <button class="add-btn" onclick="addNewStudent()">+ í•™ìƒ ì¶”ê°€</button>
          </div>
        `;
      }

      students.forEach(student => {
        const statusClass = student.status ? 'status-' + student.status : '';
        html += `
          <div class="student-item ${statusClass}">
            ${isEditMode ? `<button class="delete-btn" onclick="deleteStudent('${student.name}')">Ã—</button>` : ''}
            <div class="student-name">${student.name}</div>
            <div class="student-info">
              ${student.route} | ${student.station} | ${student.time}
            </div>
            <div class="student-actions">
              <button class="status-btn ${student.status === 'ê²°ì„' ? 'active' : ''}"
                      onclick="changeStatus('${student.name}', 'ê²°ì„')">ê²°ì„</button>
              <button class="status-btn ${student.status === 'ì‹œê°„ë³€ê²½' ? 'active' : ''}"
                      onclick="changeStatus('${student.name}', 'ì‹œê°„ë³€ê²½')">ì‹œê°„ë³€ê²½</button>
              <button class="status-btn ${student.status === 'ì§ì ‘ë“±ì›' ? 'active' : ''}"
                      onclick="changeStatus('${student.name}', 'ì§ì ‘ë“±ì›')">ì§ì ‘ë“±ì›</button>
              <button class="status-btn" onclick="changeStatus('${student.name}', null)">ì´ˆê¸°í™”</button>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // í¸ì§‘ ëª¨ë“œ í† ê¸€
    function toggleEditMode() {
      isEditMode = !isEditMode;
      const btn = document.getElementById('editBtn');
      const list = document.getElementById('studentsList');

      if (isEditMode) {
        btn.textContent = 'ì™„ë£Œ';
        btn.classList.add('active');
        list.classList.add('edit-mode');
      } else {
        btn.textContent = 'ì¶”ê°€ì‚­ì œ';
        btn.classList.remove('active');
        list.classList.remove('edit-mode');
      }

      renderStudents();
    }

    // ìƒíƒœ ë³€ê²½
    function changeStatus(name, status) {
      const currentStatus = allStudents.find(s => s.name === name && s.day === currentDay)?.status;

      // ê°™ì€ ìƒíƒœ í´ë¦­í•˜ë©´ ì´ˆê¸°í™”
      if (currentStatus === status) {
        status = null;
      }

      google.script.run
        .withSuccessHandler(function() {
          showToast('ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadAllData();
        })
        .withFailureHandler(function(error) {
          showToast('ì˜¤ë¥˜: ' + error);
        })
        .updateStatus(name, status, currentDay);
    }

    // í•™ìƒ ì¶”ê°€
    function addNewStudent() {
      const name = document.getElementById('newName').value.trim();
      const route = document.getElementById('newRoute').value.trim();
      const station = document.getElementById('newStation').value.trim();
      const time = document.getElementById('newTime').value;

      if (!name) {
        showToast('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }

      google.script.run
        .withSuccessHandler(function() {
          showToast('í•™ìƒì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
          document.getElementById('newName').value = '';
          document.getElementById('newRoute').value = '';
          document.getElementById('newStation').value = '';
          document.getElementById('newTime').value = '';
          loadAllData();
        })
        .withFailureHandler(function(error) {
          showToast('ì˜¤ë¥˜: ' + error);
        })
        .addStudent(name, route, station, time, currentDay);
    }

    // í•™ìƒ ì‚­ì œ
    function deleteStudent(name) {
      if (!confirm(name + 'ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      google.script.run
        .withSuccessHandler(function() {
          showToast('í•™ìƒì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          loadAllData();
        })
        .withFailureHandler(function(error) {
          showToast('ì˜¤ë¥˜: ' + error);
        })
        .removeStudent(name, currentDay);
    }

    // í† ìŠ¤íŠ¸ ë©”ì‹œì§€
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(function() {
        toast.classList.remove('show');
      }, 3000);
    }
  </script>
</body>
</html>
