<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>버스 탑승 관리</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #f5f5f5;
      padding: 8px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .header {
      background: #2196F3;
      color: white;
      padding: 16px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
    }

    .tabs {
      display: flex;
      border-bottom: 2px solid #e0e0e0;
      background: white;
      overflow-x: auto;
    }

    .tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      border: none;
      background: white;
      font-size: 14px;
      min-width: 60px;
    }

    .tab.active {
      background: #2196F3;
      color: white;
      font-weight: bold;
    }

    .controls {
      padding: 12px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .route-select {
      flex: 1;
      min-width: 120px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }

    .edit-btn {
      padding: 8px 16px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
    }

    .edit-btn.active {
      background: #FF9800;
    }

    .memo-section {
      padding: 12px;
      border-bottom: 1px solid #e0e0e0;
    }

    .memo-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      resize: vertical;
      min-height: 60px;
    }

    .students-list {
      padding: 8px;
    }

    .student-item {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      padding: 12px;
      margin-bottom: 8px;
      position: relative;
    }

    .student-item.status-결석 {
      background: #FFB3BA;
    }

    .student-item.status-시간변경 {
      background: #FFFFBA;
    }

    .student-item.status-직접등원 {
      background: #BAE1FF;
    }

    .student-name {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 4px;
    }

    .student-info {
      font-size: 13px;
      color: #666;
      margin-bottom: 8px;
    }

    .student-actions {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .status-btn {
      padding: 6px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      font-size: 12px;
    }

    .status-btn.active {
      background: #2196F3;
      color: white;
      border-color: #2196F3;
    }

    .delete-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 16px;
      display: none;
    }

    .edit-mode .delete-btn {
      display: block;
    }

    .add-student-form {
      background: #f9f9f9;
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 4px;
      border: 2px dashed #ccc;
      display: none;
    }

    .edit-mode .add-student-form {
      display: block;
    }

    .form-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .form-input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }

    .add-btn {
      width: 100%;
      padding: 10px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #323232;
      color: white;
      padding: 12px 24px;
      border-radius: 4px;
      display: none;
      z-index: 1000;
    }

    .toast.show {
      display: block;
      animation: fadeIn 0.3s, fadeOut 0.3s 2.7s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateX(-50%) translateY(20px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">🚌 버스 탑승 관리</div>

    <div class="tabs">
      <button class="tab active" onclick="changeDay('월')">월</button>
      <button class="tab" onclick="changeDay('화')">화</button>
      <button class="tab" onclick="changeDay('수')">수</button>
      <button class="tab" onclick="changeDay('목')">목</button>
      <button class="tab" onclick="changeDay('금')">금</button>
      <button class="tab" onclick="changeDay('토')">토</button>
      <button class="tab" onclick="changeDay('일')">일</button>
    </div>

    <div class="controls">
      <select class="route-select" id="routeSelect" onchange="filterByRoute()">
        <option value="">전체 노선</option>
      </select>
      <button class="edit-btn" id="editBtn" onclick="toggleEditMode()">추가삭제</button>
    </div>

    <div class="memo-section">
      <textarea class="memo-input" id="memoInput" placeholder="메모 입력..." oninput="saveMemoDebounced()"></textarea>
    </div>

    <div class="students-list" id="studentsList">
      <div class="loading">로딩 중...</div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    let allStudents = [];
    let currentDay = '월';
    let currentRoute = '';
    let isEditMode = false;
    let memoSaveTimeout = null;

    // 초기 로드
    window.onload = function() {
      loadAllData();
    };

    // 모든 데이터 로드
    function loadAllData() {
      google.script.run
        .withSuccessHandler(function(students) {
          allStudents = students;
          updateRouteFilter();
          loadMemo();
          renderStudents();
        })
        .withFailureHandler(function(error) {
          showToast('데이터 로드 실패: ' + error);
        })
        .getAllStudents();
    }

    // 요일 변경
    function changeDay(day) {
      currentDay = day;

      // 탭 활성화
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.textContent.includes(day)) {
          tab.classList.add('active');
        }
      });

      updateRouteFilter();
      loadMemo();
      renderStudents();
    }

    // 노선 필터 업데이트
    function updateRouteFilter() {
      const dayStudents = allStudents.filter(s => s.day === currentDay);
      const routes = [...new Set(dayStudents.map(s => s.route))].filter(r => r);

      const select = document.getElementById('routeSelect');
      select.innerHTML = '<option value="">전체 노선</option>';
      routes.forEach(route => {
        const option = document.createElement('option');
        option.value = route;
        option.textContent = route;
        if (route === currentRoute) option.selected = true;
        select.appendChild(option);
      });
    }

    // 노선별 필터
    function filterByRoute() {
      currentRoute = document.getElementById('routeSelect').value;
      renderStudents();
    }

    // 메모 로드
    function loadMemo() {
      google.script.run
        .withSuccessHandler(function(memo) {
          document.getElementById('memoInput').value = memo;
        })
        .getMemo(currentDay);
    }

    // 메모 저장 (디바운스)
    function saveMemoDebounced() {
      if (memoSaveTimeout) clearTimeout(memoSaveTimeout);
      memoSaveTimeout = setTimeout(function() {
        const memo = document.getElementById('memoInput').value;
        google.script.run
          .withSuccessHandler(function() {
            // 자동 저장 - 토스트 표시 안 함
          })
          .saveMemo(currentDay, memo);
      }, 1000);
    }

    // 학생 목록 렌더링
    function renderStudents() {
      let students = allStudents.filter(s => s.day === currentDay);

      if (currentRoute) {
        students = students.filter(s => s.route === currentRoute);
      }

      const container = document.getElementById('studentsList');

      if (students.length === 0) {
        container.innerHTML = '<div class="loading">학생이 없습니다.</div>';
        return;
      }

      let html = '';

      // 편집 모드일 때 추가 폼
      if (isEditMode) {
        html += `
          <div class="add-student-form">
            <div class="form-row">
              <input type="text" class="form-input" id="newName" placeholder="이름">
              <input type="text" class="form-input" id="newRoute" placeholder="노선">
            </div>
            <div class="form-row">
              <input type="text" class="form-input" id="newStation" placeholder="정류장">
              <input type="time" class="form-input" id="newTime">
            </div>
            <button class="add-btn" onclick="addNewStudent()">+ 학생 추가</button>
          </div>
        `;
      }

      students.forEach(student => {
        const statusClass = student.status ? 'status-' + student.status : '';
        html += `
          <div class="student-item ${statusClass}">
            ${isEditMode ? `<button class="delete-btn" onclick="deleteStudent('${student.name}')">×</button>` : ''}
            <div class="student-name">${student.name}</div>
            <div class="student-info">
              ${student.route} | ${student.station} | ${student.time}
            </div>
            <div class="student-actions">
              <button class="status-btn ${student.status === '결석' ? 'active' : ''}"
                      onclick="changeStatus('${student.name}', '결석')">결석</button>
              <button class="status-btn ${student.status === '시간변경' ? 'active' : ''}"
                      onclick="changeStatus('${student.name}', '시간변경')">시간변경</button>
              <button class="status-btn ${student.status === '직접등원' ? 'active' : ''}"
                      onclick="changeStatus('${student.name}', '직접등원')">직접등원</button>
              <button class="status-btn" onclick="changeStatus('${student.name}', null)">초기화</button>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // 편집 모드 토글
    function toggleEditMode() {
      isEditMode = !isEditMode;
      const btn = document.getElementById('editBtn');
      const list = document.getElementById('studentsList');

      if (isEditMode) {
        btn.textContent = '완료';
        btn.classList.add('active');
        list.classList.add('edit-mode');
      } else {
        btn.textContent = '추가삭제';
        btn.classList.remove('active');
        list.classList.remove('edit-mode');
      }

      renderStudents();
    }

    // 상태 변경
    function changeStatus(name, status) {
      const currentStatus = allStudents.find(s => s.name === name && s.day === currentDay)?.status;

      // 같은 상태 클릭하면 초기화
      if (currentStatus === status) {
        status = null;
      }

      google.script.run
        .withSuccessHandler(function() {
          showToast('상태가 변경되었습니다.');
          loadAllData();
        })
        .withFailureHandler(function(error) {
          showToast('오류: ' + error);
        })
        .updateStatus(name, status, currentDay);
    }

    // 학생 추가
    function addNewStudent() {
      const name = document.getElementById('newName').value.trim();
      const route = document.getElementById('newRoute').value.trim();
      const station = document.getElementById('newStation').value.trim();
      const time = document.getElementById('newTime').value;

      if (!name) {
        showToast('이름을 입력하세요.');
        return;
      }

      google.script.run
        .withSuccessHandler(function() {
          showToast('학생이 추가되었습니다.');
          document.getElementById('newName').value = '';
          document.getElementById('newRoute').value = '';
          document.getElementById('newStation').value = '';
          document.getElementById('newTime').value = '';
          loadAllData();
        })
        .withFailureHandler(function(error) {
          showToast('오류: ' + error);
        })
        .addStudent(name, route, station, time, currentDay);
    }

    // 학생 삭제
    function deleteStudent(name) {
      if (!confirm(name + '을(를) 삭제하시겠습니까?')) return;

      google.script.run
        .withSuccessHandler(function() {
          showToast('학생이 삭제되었습니다.');
          loadAllData();
        })
        .withFailureHandler(function(error) {
          showToast('오류: ' + error);
        })
        .removeStudent(name, currentDay);
    }

    // 토스트 메시지
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(function() {
        toast.classList.remove('show');
      }, 3000);
    }
  </script>
</body>
</html>
